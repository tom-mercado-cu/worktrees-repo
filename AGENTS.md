# AGENTS.md

This file provides guidance to AI coding assistants (Claude Code, Cursor, GitHub Copilot, etc.) when working with this repository.

## Project Overview

This is a **git worktree management toolkit** - a collection of bash scripts that simplify creating and managing git worktrees for both single-repo and multi-repo workflows. It's designed to work seamlessly with AI coding assistants by providing isolated workspaces for each task.

## Essential Commands for Development

### Testing Scripts
```bash
# Test single-repo workflow (from inside a repo)
./wt-new.sh feature/test-branch

# Test multi-repo workflow (from directory with multiple repos)
./wt-multi-new.sh

# Test navigation
source ./wt-list.sh

# Test cleanup
./wt-clean.sh

# Test installation (non-interactive)
./install.sh -y
```

### No Build/Test/Lint Commands
This is a pure bash script repository with no build system, test framework, or linters. Changes should be tested manually by running the scripts.

## Documentation Maintenance (CRITICAL)

**When making ANY change to script functionality, flags, or commands, you MUST update these files:**

1. **README.md** - User-facing documentation
   - Update command tables with new flags/options
   - Add examples demonstrating new features
   - Update "Command Reference" section
   - Update "Flags" table
   - Add real-world examples if applicable

2. **wt-help.sh** - Built-in help command
   - Update command syntax in help output
   - Add new flags to descriptions
   - Update examples section
   - Keep consistent with README.md

3. **AGENTS.md** (this file) - AI assistant guidance
   - Update architecture information for significant changes
   - Add new patterns or conventions
   - Update command lists if new scripts are added

**Example: Adding a new flag**
If you add `-x` flag to `wt-new.sh`:
- ✅ Update `wt-new.sh` with functionality
- ✅ Update README.md command table: `wt-new [repo] <branch> [-c] [-x]`
- ✅ Update README.md flags table: Add row for `-x, --example`
- ✅ Update README.md examples: Show `-x` flag in use
- ✅ Update wt-help.sh: Add `-x` to command description and examples
- ✅ Update AGENTS.md if it introduces new patterns

**This is NOT optional.** Outdated documentation causes user confusion and makes the tool harder to use.

## Architecture

### Core Script Components

**Single-Repo Commands:**
- `wt-new.sh` - Create worktree with new branch
- `wt-existing.sh` - Create worktree for existing branch

**Multi-Repo Commands:**
- `wt-multi-new.sh` - Create worktrees across multiple repositories

**Management Commands:**
- `wt-list.sh` - Navigate to existing worktrees (must be sourced)
- `wt-clean.sh` - Remove worktrees with optional branch deletion
- `wt-prune.sh` - Clean orphaned worktree references
- `wt-agent.sh` - Generate AGENTS.md context file from template

**Installation:**
- `install.sh` - Add aliases to .zshrc
- `update.sh` - Update to latest version
- `remote-install.sh` - One-liner curl installation

### Key Implementation Patterns

**Branch Name Sanitization:**
```bash
BRANCH_DIR_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
# feature/GTT-1234 → feature-GTT-1234
```

**Default Branch Detection:**
Tries multiple methods to find main vs master:
1. `git symbolic-ref refs/remotes/origin/HEAD`
2. Check for `refs/remotes/origin/main`
3. Check for `refs/remotes/origin/master`
4. Fall back to current branch

**Package Manager Detection:**
Auto-detects based on lock files: pnpm-lock.yaml → yarn.lock → package-lock.json → default to npm

**Worktree Verification:**
```bash
if [ -f "$repo_dir/.git" ]; then
    # It's a worktree (has .git file, not directory)
fi
```

**wt-list.sh Must Be Sourced:**
This script changes the current shell's directory, so it must be sourced (not executed). The alias uses `source`:
```bash
alias wt-list='source $SCRIPT_DIR/wt-list.sh'
```

### Directory Structure Created by Tools

```
~/projects/
├── subscription-front/              # Main repo
├── subscription-back/               # Main repo
└── worktrees/                       # All worktrees created here
    ├── feature-GTT-1234-auth/
    │   ├── subscription-front/      # Worktree
    │   ├── subscription-back/       # Worktree
    │   ├── AGENTS.md                # Generated by wt-agent
    │   └── feature-GTT-1234-auth.code-workspace
    └── bugfix-fix/
        └── subscription-front/      # Single-repo worktree
```

## Script Coding Conventions

1. **Error Handling:** Use `set -e` at top of scripts (except wt-list.sh which is sourced)
2. **Colors:** Define standard colors at top (RED, GREEN, YELLOW, BLUE, CYAN, NC, BOLD, DIM)
3. **Visual Headers:** Box drawing with colored titles for consistency
4. **Progress Indicators:**
   - `→` for actions in progress
   - `✓` for success
   - `⚠` for warnings
5. **User Prompts:** Use defaults with brackets, e.g., `[Y/n]`
6. **Path Quoting:** Always quote variables containing paths: `"$VARIABLE"`
7. **Git Commands:** Use `--quiet` flag and redirect errors when appropriate: `2>/dev/null || true`
8. **Cross-platform sed:** Check for macOS vs Linux:
   ```bash
   if [[ "$OSTYPE" == "darwin"* ]]; then
       sed -i '' "s/pattern/replacement/" "$FILE"
   else
       sed -i "s/pattern/replacement/" "$FILE"
   fi
   ```

## Template System

**AGENTS.template.md** contains placeholders replaced by wt-agent.sh:
- `{{FEATURE_NAME}}` - Directory name
- `{{BRANCH_NAME}}` - Git branch name
- `{{DESCRIPTION}}` - User-provided description
- `{{REPOS_LIST}}` - Bullet list of repos with branches
- `{{REPOS_TREE}}` - Tree visualization of directory structure
- `{{TIMESTAMP}}` - Generation timestamp

## Important Notes

- Scripts detect whether they're run from inside a repo or from parent directory
- Multi-repo scripts scan current directory for git repositories
- Workspace files use relative paths (`./repo-name`)
- Branch deletion is optional and prompted after worktree removal
- All commands support `-c` flag to auto-open in Cursor
- Installation resolves symlinked .zshrc files to real paths
